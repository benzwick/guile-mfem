# build-and-test-callable.yml
#
#  - Builds guile-mfem in three stages:
#    - MFEM dependencies + MFEM
#    - SWIG bindings
#    - guile-mfem
#  - Runs tests under `run_examples.py`
#  - If there is a failure, uploads test outputs as an artifact

name: Build and Test

on:
  workflow_call:
    inputs:
      os:
        description: 'Operating system'
        type: string
        default: 'ubuntu-latest'
      guile-version:
        description: 'Guile version'
        type: string
        default: '3.0'
      mfem-branch:
        description: 'MFEM branch to checkout'
        type: string
        default: 'default' # 'default' uses a specific commit hash defined in CMakeLists.txt
      parallel:
        description: 'Build parallel version'
        type: boolean
        default: false
      cuda:
        description: 'Build with CUDA'
        type: boolean
        default: false
      cuda-toolkit-version:
        type: string
        default: '12.6.0'
      cuda-driver-version:
        type: string
        default: '560.28.03'
      libceed:
        description: 'Build with libCEED'
        type: boolean
        default: false
      gslib:
        description: 'Build with GSlib'
        type: boolean
        default: false

jobs:
  build-and-test:
    runs-on: ${{ inputs.os }}

    # Reference for $${{ x && y || z }} syntax: https://7tonshark.com/posts/github-actions-ternary-operator/
    name: >-
      ${{ inputs.os }} |
      ${{ inputs.mfem-branch }} |
      ${{ inputs.guile-version }} |
      ${{ inputs.parallel && 'parallel' || 'serial' }}
      ${{ inputs.cuda && '| cuda' || '' }}${{ inputs.libceed && '| libceed' || '' }}${{ inputs.gslib && '| gslib' || '' }}

    env:
      CUDA_HOME: '/usr/local/cuda'
      # These are all passed to cmake as -D options
      cmake-flags: >-
        ${{ inputs.parallel && '-DGUILE_MFEM_USE_MPI=ON' || '' }}
        ${{ inputs.cuda && '-DGUILE_MFEM_USE_CUDA=ON' || '' }}
        ${{ inputs.libceed && '-DGUILE_MFEM_USE_LIBCEED=ON' || '' }}
        ${{ inputs.gslib && '-DGUILE_MFEM_USE_GSLIB=ON' || '' }}
        -DMFEM_DIR=${{ github.workspace }}/mfem-install

    # -------------------------------------------------------------------------------------------------
    # Begin workflow
    # -------------------------------------------------------------------------------------------------
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # -------------------------------------------------------------------------------------------------
    # Download/install dependencies
    # -------------------------------------------------------------------------------------------------
    - name: Install core dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y guile-${{ inputs.guile-version }}-dev cmake swig

    #- name: Install chrpath on ubuntu
    #  if: inputs.os == 'ubuntu-latest'
    #  run: |
    #    sudo apt-get install chrpath

    - name: Install MPI
      if: inputs.parallel
      run: |
        sudo apt-get install -y openmpi-bin libopenmpi-dev
        export OMPI_MCA_rmaps_base_oversubscribe=1

    - name: Cache CUDA
      if: inputs.cuda
      id: cache-cuda
      uses: actions/cache@v4
      with:
        path: ~/cache
        key: cuda-installer-${{ inputs.cuda-toolkit-version }}-${{ inputs.cuda-driver-version }}

    - name: Download CUDA
      if: inputs.cuda && steps.cache-cuda.outputs.cache-hit == false
      run: |
        CUDA_URL="https://developer.download.nvidia.com/compute/cuda/${{ inputs.cuda-toolkit-version }}/local_installers/cuda_${{ inputs.cuda-toolkit-version }}_${{ inputs.cuda-driver-version }}_linux.run"
        curl -o ~/cache/cuda.run --create-dirs $CUDA_URL

    - name: Install CUDA
      if: inputs.cuda
      run: |
        # The --silent flag is necessary to bypass user-input, e.g. accepting the EULA
        sudo sh ~/cache/cuda.run --silent --toolkit
        echo "/usr/local/cuda/bin" >> $GITHUB_PATH

    - name: Print dependency information
      run: |
        guile --version
        cmake --version
        swig -version
        printf "\n\n---------- MPI ----------\n"
        mpiexec --version || printf "MPI not installed"
        printf "\n\n---------- CUDA ----------\n"
        nvcc --version || printf "CUDA not installed"

    # -------------------------------------------------------------------------------------------------
    # Build MFEM + SWIG Bindings + guile-mfem
    # -------------------------------------------------------------------------------------------------
    - name: Determine MFEM ref
      id: mfem-ref
      run: |
        if [ "${{ inputs.mfem-branch }}" = "default" ]; then
          echo "ref=$(sed -n 's/.*GUILE_MFEM_MFEM_SHA "\([0-9a-f]*\)".*/\1/p' CMakeLists.txt)" >> $GITHUB_OUTPUT
        else
          echo "ref=${{ inputs.mfem-branch }}" >> $GITHUB_OUTPUT
        fi

    - name: Cache MFEM
      id: cache-mfem
      uses: actions/cache@v4
      with:
        path: mfem-install
        key: mfem-shared-${{ inputs.os }}-${{ steps.mfem-ref.outputs.ref }}-${{ inputs.parallel && 'parallel' || 'serial' }}${{ inputs.cuda && '-cuda' || '' }}

    - name: Clone MFEM
      if: steps.cache-mfem.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/mfem/mfem.git mfem-src
        cd mfem-src
        git checkout ${{ steps.mfem-ref.outputs.ref }}

    - name: Build MFEM (step 1)
      if: steps.cache-mfem.outputs.cache-hit != 'true'
      run: |
        cmake -S mfem-src -B mfem-build \
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/mfem-install \
          -DBUILD_SHARED_LIBS=ON \
          -DMFEM_ENABLE_TESTING=OFF \
          -DMFEM_ENABLE_EXAMPLES=OFF \
          -DMFEM_ENABLE_MINIAPPS=OFF \
          ${{ inputs.parallel && '-DMFEM_USE_MPI=ON -DMFEM_FETCH_TPLS=ON' || '' }} \
          ${{ inputs.cuda && '-DMFEM_USE_CUDA=ON' || '' }}
        cmake --build mfem-build -j$(nproc)
        cmake --install mfem-build

    - name: Build SWIG bindings + guile-mfem (steps 2-3)
      run: cmake -B build ${{ env.cmake-flags }} && cmake --build build -j$(nproc)

    # -------------------------------------------------------------------------------------------------
    # Run tests
    # -------------------------------------------------------------------------------------------------
    - name: Run tests (serial)
      if: inputs.parallel == false
      run: |
        cd build && LD_LIBRARY_PATH=${{ github.workspace }}/mfem-install/lib ctest --output-on-failure -L serial

    - name: Run tests (parallel)
      if: inputs.parallel
      run: |
        cd build && LD_LIBRARY_PATH=${{ github.workspace }}/mfem-install/lib ctest --output-on-failure -L parallel

    # -------------------------------------------------------------------------------------------------
    # Generate an artifact (output of tests) on failure
    # -------------------------------------------------------------------------------------------------
    - name: Generate test results artifact
      id: generate-artifact
      run: |
        tar -cvzf sandbox.tar.gz build/Testing/ || true
        txt=$(date +%H_%M_%S_%N)
        echo name="test_results_"${txt}"_"${{ github.run_id }}".tar.gz" >> $GITHUB_OUTPUT

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      if: failure()
      with:
          name: ${{ steps.generate-artifact.outputs.name }}
          path: sandbox.tar.gz
          retention-days: 1
